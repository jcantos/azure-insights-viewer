<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure Insights Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .log-entry {
            transition: all 0.2s ease;
        }
        .log-entry:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .json-viewer {
            background-color: #f8f9fa;
            border-radius: 0.375rem;
            padding: 0.75rem;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .blink {
            animation: blink 1.5s infinite;
        }
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .alert-toast {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            display: flex;
            align-items: center;
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-chart-line text-3xl text-blue-600"></i>
                    <h1 class="text-3xl font-bold text-gray-800">Azure Insights Viewer</h1>
                </div>
                <div class="flex items-center space-x-2">
                    <span id="connection-status" class="px-3 py-1 rounded-full text-sm font-medium bg-gray-200 text-gray-800">
                        <i class="fas fa-circle text-gray-500 mr-1"></i> Disconnected
                    </span>
                </div>
            </div>
            <p class="text-gray-600 mt-2">View and analyze your Application Insights logs in real-time</p>
        </header>

        <!-- Connection Form -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Connection Settings</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="applicationId" class="block text-sm font-medium text-gray-700 mb-1">Application ID</label>
                    <input type="text" id="applicationId" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="apiKey" class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                    <div class="flex">
                        <input type="password" id="apiKey" placeholder="Enter your API key"
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-l-lg focus:ring-blue-500 focus:border-blue-500">
                        <button id="toggleVisibility" class="px-3 bg-gray-100 border border-l-0 border-gray-300 rounded-r-lg text-gray-600 hover:bg-gray-200">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="mt-4 flex justify-end">
                <button id="connectBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition duration-150 ease-in-out">
                    <i class="fas fa-plug mr-2"></i> Connect
                </button>
            </div>
        </div>

        <!-- Filters -->
        <div id="pnl-filters" class="bg-white rounded-lg shadow-md p-6 mb-8" style="display: none;">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Filters</h2>

            <div class="mt-4 flex items-center space-x-4 mb-4">
                <div class="flex-1">
                    <label for="timeRange" class="block text-sm font-medium text-gray-700 mb-1">Time Range</label>
                    <select id="timeRange" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="1">Last 1 hour</option>
                        <option value="4" selected>Last 4 hours</option>
                        <option value="24">Last 24 hours</option>
                        <option value="168">Last 7 days</option>
                        <option value="custom">Custom range</option>
                    </select>
                </div>
                <div id="customRangeContainer" class="hidden flex-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Custom Range</label>
                    <div class="flex space-x-2">
                        <input type="datetime-local" id="startTime" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <input type="datetime-local" id="endTime" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label for="logType" class="block text-sm font-medium text-gray-700 mb-1">Log Type</label>
                    <select id="logType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="all">All Logs</option>
                        <option value="customEvents">Custom Events</option>
                        <option value="exceptions">Exceptions</option>
                    </select>
                </div>
                <div>
                    <label for="severity" class="block text-sm font-medium text-gray-700 mb-1">Severity Level</label>
                    <select id="severity" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="all">All</option>
                        <option value="verbose">Verbose</option>
                        <option value="info">Info</option>
                        <option value="warning">Warning</option>
                        <option value="error">Error</option>
                        <option value="critical">Critical</option>
                    </select>
                </div>
                <div>
                    <label for="searchTerm" class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                    <input type="text" id="searchTerm" placeholder="Search in logs..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="mt-auto">
                    <button id="applyFilters" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition duration-150 ease-in-out">
                        <i class="fas fa-filter mr-2"></i> Apply Filters
                    </button>
                </div>
            </div>
            
            <!-- New Custom Dimensions Filter Section -->
            <div class="mt-4 border-t pt-4">
                <h3 class="text-lg font-medium text-gray-800 mb-2">Custom Dimensions Filter</h3>
                <div id="customDimensionsFilters" class="space-y-2">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                        <div>
                            <select id="dimensionKey" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Select dimension</option>
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                        <div>
                            <select id="dimensionOperator" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <option value="contains">contains</option>
                                <option value="equals">equals</option>
                                <option value="startsWith">starts with</option>
                                <option value="endsWith">ends with</option>
                                <option value="exists">exists</option>
                                <option value="notExists">does not exist</option>
                            </select>
                        </div>
                        <div class="flex">
                            <input type="text" id="dimensionValue" placeholder="Value" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <button id="addDimensionFilter" class="ml-2 px-3 bg-gray-100 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-200">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div id="activeDimensionFilters" class="space-y-2 mt-2">
                        <!-- Active filters will appear here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs Display -->
        <div id="pnl-results" class="bg-white rounded-lg shadow-md overflow-hidden" style="display: none;">
            <div class="border-b border-gray-200 px-6 py-4 flex justify-between items-center">
                <h2 class="text-xl font-semibold text-gray-800">Log Entries</h2>
                <div class="flex items-center space-x-4">
                    <button id="refreshBtn" class="text-blue-600 hover:text-blue-800">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button id="clearBtn" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-trash-alt"></i> Clear
                    </button>
                </div>
            </div>
            
            <div class="p-4">
                <div id="loadingIndicator" class="hidden text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-600 mb-2"></div>
                    <p class="text-gray-600">Loading logs...</p>
                </div>
                
                <div id="noLogsMessage" class="hidden text-center py-12">
                    <i class="fas fa-inbox text-4xl text-gray-300 mb-4"></i>
                    <h3 class="text-xl font-medium text-gray-700">No logs available</h3>
                    <p class="text-gray-500 mt-1">Connect to Application Insights to view logs</p>
                </div>
                
                <div id="logsContainer" class="hidden space-y-4 max-h-[600px] overflow-y-auto custom-scrollbar">
                    <!-- Log entries will be inserted here by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Log Details Modal -->
    <div id="logDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="border-b border-gray-200 px-6 py-4 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-800">Log Details</h3>
                <button id="closeModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto flex-1">
                <div id="logDetailsContent" class="json-viewer">
                    <!-- Log details will be inserted here -->
                </div>
            </div>
            <div class="border-t border-gray-200 px-6 py-4 flex justify-end">
                <button id="copyDetails" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition duration-150 ease-in-out mr-2">
                    <i class="fas fa-copy mr-2"></i> Copy
                </button>
                <button id="closeModalBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg transition duration-150 ease-in-out">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM elements
            const applicationIdInput = document.getElementById('applicationId');
            const apiKeyInput = document.getElementById('apiKey');
            const toggleVisibilityBtn = document.getElementById('toggleVisibility');
            const connectBtn = document.getElementById('connectBtn');
            const connectionStatus = document.getElementById('connection-status');
            const timeRangeSelect = document.getElementById('timeRange');
            const customRangeContainer = document.getElementById('customRangeContainer');
            const logTypeSelect = document.getElementById('logType');
            const severitySelect = document.getElementById('severity');
            const searchTermInput = document.getElementById('searchTerm');
            const applyFiltersBtn = document.getElementById('applyFilters');
            const refreshBtn = document.getElementById('refreshBtn');
            const clearBtn = document.getElementById('clearBtn');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const noLogsMessage = document.getElementById('noLogsMessage');
            const logsContainer = document.getElementById('logsContainer');
            const logDetailsModal = document.getElementById('logDetailsModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const closeModal = document.getElementById('closeModal');
            const copyDetailsBtn = document.getElementById('copyDetails');
            const logDetailsContent = document.getElementById('logDetailsContent');
            const dimensionKeySelect = document.getElementById('dimensionKey');
            const dimensionOperatorSelect = document.getElementById('dimensionOperator');
            const dimensionValueInput = document.getElementById('dimensionValue');
            const addDimensionFilterBtn = document.getElementById('addDimensionFilter');
            const activeDimensionFiltersContainer = document.getElementById('activeDimensionFilters');
            const pnlFilters = document.getElementById('pnl-filters');
            const pnlResults = document.getElementById('pnl-results');

            // State variables
            let isConnected = false;
            let logsData = [];
            let filteredLogs = [];
            let currentAppId = '';
            let currentApiKey = '';

            // State for custom dimensions filters
            let customDimensionsKeys = [];
            let activeDimensionFilters = [];

            // Event listeners
            toggleVisibilityBtn.addEventListener('click', togglePasswordVisibility);
            connectBtn.addEventListener('click', toggleConnection);
            timeRangeSelect.addEventListener('change', handleTimeRangeChange);
            applyFiltersBtn.addEventListener('click', fetchLogs);
            refreshBtn.addEventListener('click', refreshLogs);
            clearBtn.addEventListener('click', clearLogs);
            closeModalBtn.addEventListener('click', closeModalWindow);
            closeModal.addEventListener('click', closeModalWindow);
            copyDetailsBtn.addEventListener('click', copyLogDetails);
            addDimensionFilterBtn.addEventListener('click', addDimensionFilter);
            
            // Initialize
            checkStoredConnection();
            
            // Functions
            function togglePasswordVisibility() {
                const type = apiKeyInput.getAttribute('type') === 'password' ? 'text' : 'password';
                apiKeyInput.setAttribute('type', type);
                toggleVisibilityBtn.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
            }
            
            function toggleConnection() {
                if (isConnected) {
                    disconnect();
                } else {
                    connect();
                }
            }
            
            function connect() {
                currentAppId = applicationIdInput.value.trim();
                currentApiKey = apiKeyInput.value.trim();
                
                if (!currentAppId || !currentApiKey) {
                    showAlert('Please enter both Application ID and API Key', 'error');
                    return;
                }
                
                // Validate Application ID format (GUID)
                if (!isValidGuid(currentAppId)) {
                    showAlert('Invalid Application ID format', 'error');
                    return;
                }
                
                showLoading(true);
                
                // Test connection with a simple query
                const testQuery = "traces | limit 1";
                
                queryApplicationInsights(testQuery)
                    .then(response => {
                        if (!response || !response.tables || !response.tables[0]) {
                            throw new Error('Invalid response from API');
                        }
                        
                        isConnected = true;
                        setVisibilityPanels();
                        updateConnectionStatus();
                        storeCredentials();
                        fetchLogs();
                        showLoading(false);
                        showAlert('Successfully connected to Application Insights', 'success');
                    })
                    .catch(error => {
                        showLoading(false);
                        showAlert('Failed to connect: ' + (error.message || 'Unknown error'), 'error');
                        console.error('Connection error:', error);
                    });
            }
            
            function setVisibilityPanels(){
                if (isConnected){
                    pnlFilters.style.display='block';
                    pnlResults.style.display='block';
                }
                else{
                    pnlFilters.style.display='none';
                    pnlResults.style.display='none';
                }
            }

            function isValidGuid(guid) {
                const regex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
                return regex.test(guid);
            }
            
            async function queryApplicationInsights(query) {
                const apiUrl = `https://api.applicationinsights.io/v1/apps/${currentAppId}/query`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': currentApiKey
                    },
                    body: JSON.stringify({ query })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error?.message || `API request failed with status ${response.status}`);
                }
                
                return await response.json();
            }
            
            function disconnect() {
                showLoading(true);
                
                setTimeout(() => {
                    isConnected = false;
                    currentAppId = '';
                    currentApiKey = '';
                    setVisibilityPanels();
                    updateConnectionStatus();
                    clearStoredCredentials();
                    clearLogs();
                    showLoading(false);
                    showAlert('Disconnected from Application Insights', 'info');
                }, 500);
            }
            
            function updateConnectionStatus() {
                if (isConnected) {
                    connectionStatus.innerHTML = '<i class="fas fa-circle text-green-500 mr-1 blink"></i> Connected';
                    connectionStatus.className = 'px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800';
                    connectBtn.innerHTML = '<i class="fas fa-plug mr-2"></i> Disconnect';
                    connectBtn.className = 'bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition duration-150 ease-in-out';
                } else {
                    connectionStatus.innerHTML = '<i class="fas fa-circle text-gray-500 mr-1"></i> Disconnected';
                    connectionStatus.className = 'px-3 py-1 rounded-full text-sm font-medium bg-gray-200 text-gray-800';
                    connectBtn.innerHTML = '<i class="fas fa-plug mr-2"></i> Connect';
                    connectBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition duration-150 ease-in-out';
                }
            }
            
            function handleTimeRangeChange() {
                if (timeRangeSelect.value === 'custom') {
                    customRangeContainer.classList.remove('hidden');
                    
                    // Set default values for custom range
                    const now = new Date();
                    const oneHourAgo = new Date(now.getTime() - 3600000);
                    
                    document.getElementById('endTime').value = now.toISOString().slice(0, 16);
                    document.getElementById('startTime').value = oneHourAgo.toISOString().slice(0, 16);
                } else {
                    customRangeContainer.classList.add('hidden');
                }
            }
            
            async function fetchLogs() {
                if (!isConnected) return;
                
                showLoading(true);
                logsContainer.classList.add('hidden');
                noLogsMessage.classList.add('hidden');
                
                try {
                    const timeRange = timeRangeSelect.value;
                    let startTime, endTime = new Date();
                    
                    // Calculate time range
                    switch (timeRange) {
                        case '1':
                            startTime = new Date(endTime.getTime() - 3600000); // 1 hour
                            break;
                        case '4':
                            startTime = new Date(endTime.getTime() - 14400000); // 4 hours
                            break;
                        case '24':
                            startTime = new Date(endTime.getTime() - 86400000); // 24 hours
                            break;
                        case '168':
                            startTime = new Date(endTime.getTime() - 604800000); // 7 days
                            break;
                        case 'custom':
                            startTime = new Date(document.getElementById('startTime').value);
                            endTime = new Date(document.getElementById('endTime').value);
                            break;
                        default:
                            startTime = new Date(endTime.getTime() - 14400000); // Default 4 hours
                    }
                    
                    // Format for query
                    const startTimeStr = startTime.toISOString();
                    const endTimeStr = endTime.toISOString();
                    
                    // Build query based on selected filters
                    let query = `
                    union traces, exceptions, customEvents
                    | where timestamp >= datetime(${startTimeStr}) and timestamp <= datetime(${endTimeStr})
                    `;
                    
                    // Apply log type filter
                    const logType = logTypeSelect.value;
                    if (logType === 'customEvents') {
                        query += `\n| where itemType == 'customEvent'`;
                    } else if (logType === 'exceptions') {
                        query += `\n| where itemType == 'exception'`;
                    }
                    
                    // Apply severity filter
                    const severity = severitySelect.value;
                    if (severity !== 'all') {
                        query += `\n| where severityLevel == '${severity}'`;
                    }
                    
                    // Finalize query
                    query += `\n| order by timestamp desc\n| limit 100`;
                    
                    // Execute query
                    const response = await queryApplicationInsights(query);
                    
                    if (!response.tables || !response.tables[0]) {
                        throw new Error('No data returned');
                    }
                    
                    // Transform API response to our log format
                    logsData = response.tables[0].rows.map(row => {
                        const columns = response.tables[0].columns;
                        const log = {
                            id: `log-${Math.random().toString(36).substr(2, 9)}`,
                            timestamp: row[columns.findIndex(c => c.name === 'timestamp')],
                            type: row[columns.findIndex(c => c.name === 'itemType')]?.toLowerCase() || 'unknown',
                            severity: mapSeverityLevel(row[columns.findIndex(c => c.name === 'severityLevel')]),
                            raw: row
                        };
                        
                        // Add type-specific fields
                        if (log.type === 'customevent') {
                            log.name = row[columns.findIndex(c => c.name === 'name')] || 'Custom Event';
                            log.properties = {
                                customDimensions: row[columns.findIndex(c => c.name === 'customDimensions')]
                            };
                        } else if (log.type === 'exception') {
                            log.name = row[columns.findIndex(c => c.name === 'problemId')] || 'Exception';
                            log.properties = {
                                customDimensions: row[columns.findIndex(c => c.name === 'customDimensions')],
                                details: {
                                    message: row[columns.findIndex(c => c.name === 'outerMessage')],
                                    stackTrace: row[columns.findIndex(c => c.name === 'details')]
                                }
                            };
                        } else {
                            log.name = log.type.charAt(0).toUpperCase() + log.type.slice(1);
                            log.properties = {
                                message: row[columns.findIndex(c => c.name === 'message')],
                                customDimensions: row[columns.findIndex(c => c.name === 'customDimensions')]
                            };
                        }
                        
                        return log;
                    });

                    // After loading logs, extract custom dimensions keys
                    extractCustomDimensionsKeys();
                    
                    applyFilters();
                    showLoading(false);
                } catch (error) {
                    showLoading(false);
                    showAlert('Failed to fetch logs: ' + error.message, 'error');
                    console.error('Error fetching logs:', error);
                }
            }
            
            function mapSeverityLevel(level) {
                if (typeof level === 'number') {
                    switch (level) {
                        case 0: return 'verbose';
                        case 1: return 'info';
                        case 2: return 'warning';
                        case 3: return 'error';
                        case 4: return 'critical';
                        default: return 'info';
                    }
                }
                return level?.toLowerCase() || 'info';
            }
            
            function applyFilters() {
                if (!logsData.length) {
                    noLogsMessage.classList.remove('hidden');
                    logsContainer.classList.add('hidden');
                    return;
                }
                
                const logType = logTypeSelect.value;
                const severity = severitySelect.value;
                const searchTerm = searchTermInput.value.toLowerCase();
                
                filteredLogs = logsData.filter(log => {
                    // Filter by log type
                    if (logType !== 'all') {
                        if (logType === 'customEvents' && log.type !== 'customevent') return false;
                        if (logType === 'exceptions' && log.type !== 'exception') return false;
                    }
                    
                    // Filter by severity
                    if (severity !== 'all' && log.severity !== severity) return false;
                    
                    // Filter by search term
                    if (searchTerm) {
                        const logString = JSON.stringify(log).toLowerCase();
                        if (!logString.includes(searchTerm)) return false;
                    }
                    
                    // Filter by custom dimensions
                    if (activeDimensionFilters.length > 0) {
                        try {
                            // Parse customDimensions if it's a string
                            const customDims = typeof log.properties?.customDimensions === 'string'
                                ? JSON.parse(log.properties.customDimensions)
                                : log.properties?.customDimensions || {};
                            
                            const passesAllFilters = activeDimensionFilters.every(filter => {
                                const value = customDims[filter.key];
                                
                                // Handle case where value is null/undefined
                                if (value === null || value === undefined) {
                                    return filter.operator === 'notExists';
                                }
                                
                                const valueStr = value.toString().toLowerCase();
                                const filterValue = filter.value.toLowerCase();
                                
                                switch (filter.operator) {
                                    case 'contains':
                                        return valueStr.includes(filterValue);
                                    case 'equals':
                                        return valueStr === filterValue;
                                    case 'startsWith':
                                        return valueStr.startsWith(filterValue);
                                    case 'endsWith':
                                        return valueStr.endsWith(filterValue);
                                    case 'exists':
                                        return true;
                                    case 'notExists':
                                        return false;
                                    default:
                                        return true;
                                }
                            });
                            
                            if (!passesAllFilters) return false;
                            
                        } catch (e) {
                            console.error('Error processing customDimensions filter:', e);
                            return false; // Exclude log if there's an error parsing
                        }
                    }
                    
                    return true;
                });
                
                displayLogs();
            }

            function extractCustomDimensionsKeys() {
                const allKeys = new Set();
                
                logsData.forEach(log => {
                    try {
                        // Check if customDimensions exists and is a string
                        const dimsStr = log.properties?.customDimensions;
                        if (dimsStr && typeof dimsStr === 'string') {
                            // Parse the JSON string to object
                            const dims = JSON.parse(dimsStr);
                            if (dims && typeof dims === 'object') {
                                Object.keys(dims).forEach(key => allKeys.add(key));
                            }
                        }
                    } catch (e) {
                        console.error('Error parsing customDimensions:', e);
                    }
                });
                
                customDimensionsKeys = Array.from(allKeys).sort();
                updateDimensionKeySelect();
            }

            function updateDimensionKeySelect() {
                dimensionKeySelect.innerHTML = '<option value="">Select dimension</option>';
                
                customDimensionsKeys.forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = key;
                    dimensionKeySelect.appendChild(option);
                });
            }
            
            function addDimensionFilter() {
                const key = dimensionKeySelect.value;
                const operator = dimensionOperatorSelect.value;
                const value = dimensionValueInput.value;
                
                if (!key && operator !== 'exists' && operator !== 'notExists') {
                    showAlert('Please select a dimension key', 'error');
                    return;
                }
                
                if ((operator === 'contains' || operator === 'equals' || 
                     operator === 'startsWith' || operator === 'endsWith') && !value) {
                    showAlert('Please enter a value for the filter', 'error');
                    return;
                }
                
                const filter = { key, operator, value };
                activeDimensionFilters.push(filter);
                renderActiveDimensionFilters();
                
                // Reset inputs
                dimensionKeySelect.value = '';
                dimensionValueInput.value = '';
            }
            
            function renderActiveDimensionFilters() {
                activeDimensionFiltersContainer.innerHTML = '';
                
                activeDimensionFilters.forEach((filter, index) => {
                    const filterElement = document.createElement('div');
                    filterElement.className = 'flex items-center justify-between bg-gray-50 p-2 rounded-lg';
                    
                    let displayText;
                    if (filter.operator === 'exists') {
                        displayText = `${filter.key} exists`;
                    } else if (filter.operator === 'notExists') {
                        displayText = `${filter.key} does not exist`;
                    } else {
                        displayText = `${filter.key} ${filter.operator} "${filter.value}"`;
                    }
                    
                    filterElement.innerHTML = `
                        <span class="text-sm">${displayText}</span>
                        <button class="text-red-500 hover:text-red-700" data-index="${index}">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    
                    activeDimensionFiltersContainer.appendChild(filterElement);
                });
                
                // Add event listeners to remove buttons
                document.querySelectorAll('#activeDimensionFilters button').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        activeDimensionFilters.splice(index, 1);
                        renderActiveDimensionFilters();
                    });
                });
            }

            function displayLogs() {
                logsContainer.innerHTML = '';
                
                if (!filteredLogs.length) {
                    noLogsMessage.classList.remove('hidden');
                    logsContainer.classList.add('hidden');
                    return;
                }
                
                noLogsMessage.classList.add('hidden');
                logsContainer.classList.remove('hidden');
                
                filteredLogs.forEach(log => {
                    const logElement = createLogElement(log);
                    logsContainer.appendChild(logElement);
                });
            }
            
            function createLogElement(log) {
                const logElement = document.createElement('div');
                logElement.className = 'log-entry bg-white border border-gray-200 rounded-lg p-4 cursor-pointer hover:shadow-md';
                logElement.dataset.id = log.id;
                
                // Determine icon and color based on log type and severity
                let icon, bgColor, textColor;
                
                if (log.type === 'customevent') {
                    icon = 'fa-calendar-check';
                    bgColor = 'bg-blue-100';
                    textColor = 'text-blue-800';
                } else if (log.type === 'exception') {
                    icon = 'fa-bug';
                    bgColor = 'bg-red-100';
                    textColor = 'text-red-800';
                } else {
                    icon = 'fa-info-circle';
                    bgColor = 'bg-gray-100';
                    textColor = 'text-gray-800';
                }
                
                // Adjust color based on severity
                if (log.severity === 'warning') {
                    bgColor = 'bg-yellow-100';
                    textColor = 'text-yellow-800';
                } else if (log.severity === 'info') {
                    bgColor = 'bg-green-100';
                    textColor = 'text-green-800';
                } else if (log.severity === 'verbose') {
                    bgColor = 'bg-gray-100';
                    textColor = 'text-gray-800';
                }
                
                const time = new Date(log.timestamp).toLocaleString();
                
                logElement.innerHTML = `
                    <div class="flex items-start">
                        <div class="flex-shrink-0 mt-1">
                            <div class="h-10 w-10 rounded-full ${bgColor} flex items-center justify-center">
                                <i class="fas ${icon} ${textColor}"></i>
                            </div>
                        </div>
                        <div class="ml-4 flex-1">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-medium text-gray-900">${log.name}</h3>
                                <span class="text-sm text-gray-500">${time}</span>
                            </div>
                            <div class="mt-1 flex items-center">
                                <span class="px-2 py-1 text-xs rounded-full ${getSeverityBadgeClass(log.severity)}">
                                    ${log.severity.charAt(0).toUpperCase() + log.severity.slice(1)}
                                </span>
                                <span class="ml-2 text-sm text-gray-500">${log.type}</span>
                            </div>
                            <div class="mt-2 text-sm text-gray-600 truncate">
                                ${getLogPreview(log)}
                            </div>
                        </div>
                    </div>
                `;
                
                logElement.addEventListener('click', () => showLogDetails(log));
                return logElement;
            }
            
            function getSeverityBadgeClass(severity) {
                switch (severity) {
                    case 'critical': return 'bg-red-100 text-red-800';
                    case 'error': return 'bg-red-100 text-red-800';
                    case 'warning': return 'bg-yellow-100 text-yellow-800';
                    case 'info': return 'bg-blue-100 text-blue-800';
                    case 'verbose': return 'bg-gray-100 text-gray-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            }
            
            function getLogPreview(log) {
                if (log.type === 'customevent') {
                    return log.properties?.customDimensions?.message || 'Custom event occurred';
                } else if (log.type === 'exception') {
                    return log.properties?.details?.message || 'Exception occurred';
                } else {
                    return log.properties?.message || 'Trace log';
                }
            }
            
            function showLogDetails(log) {
                logDetailsContent.textContent = JSON.stringify(log.raw, null, 2);
                logDetailsModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }
            
            function closeModalWindow() {
                logDetailsModal.classList.add('hidden');
                document.body.style.overflow = '';
            }
            
            function copyLogDetails() {
                navigator.clipboard.writeText(logDetailsContent.textContent)
                    .then(() => {
                        const originalText = copyDetailsBtn.innerHTML;
                        copyDetailsBtn.innerHTML = '<i class="fas fa-check mr-2"></i> Copied!';
                        setTimeout(() => {
                            copyDetailsBtn.innerHTML = originalText;
                        }, 2000);
                    })
                    .catch(err => {
                        console.error('Failed to copy text: ', err);
                    });
            }
                                    
            function refreshLogs() {
                if (isConnected) {
                    fetchLogs();
                    showAlert('Logs refreshed', 'info');
                }
            }
            
            function clearLogs() {
                logsData = [];
                filteredLogs = [];
                logsContainer.innerHTML = '';
                logsContainer.classList.add('hidden');
                noLogsMessage.classList.remove('hidden');
            }
            
            function showLoading(show) {
                if (show) {
                    loadingIndicator.classList.remove('hidden');
                } else {
                    loadingIndicator.classList.add('hidden');
                }
            }
            
            function showAlert(message, type) {
                // Remove any existing alerts
                const existingAlert = document.querySelector('.alert-toast');
                if (existingAlert) existingAlert.remove();
                
                const alert = document.createElement('div');
                let bgColor, textColor;
                
                switch (type) {
                    case 'success':
                        bgColor = 'bg-green-100';
                        textColor = 'text-green-800';
                        break;
                    case 'error':
                        bgColor = 'bg-red-100';
                        textColor = 'text-red-800';
                        break;
                    case 'info':
                        bgColor = 'bg-blue-100';
                        textColor = 'text-blue-800';
                        break;
                    default:
                        bgColor = 'bg-gray-100';
                        textColor = 'text-gray-800';
                }
                
                alert.className = `alert-toast ${bgColor} ${textColor}`;
                alert.innerHTML = `
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'} mr-2"></i>
                    <span>${message}</span>
                `;
                
                document.body.appendChild(alert);
                
                setTimeout(() => {
                    alert.style.opacity = '0';
                    setTimeout(() => alert.remove(), 300);
                }, 3000);
            }
            
            function storeCredentials() {
                try {
                    localStorage.setItem('azureInsightsAppId', currentAppId);
                    localStorage.setItem('azureInsightsApiKey', currentApiKey);
                } catch (e) {
                    console.error('Failed to store credentials:', e);
                }
            }
            
            function clearStoredCredentials() {
                try {
                    localStorage.removeItem('azureInsightsAppId');
                    localStorage.removeItem('azureInsightsApiKey');
                } catch (e) {
                    console.error('Failed to clear stored credentials:', e);
                }
            }
            
            function checkStoredConnection() {
                try {
                    const storedAppId = localStorage.getItem('azureInsightsAppId');
                    const storedApiKey = localStorage.getItem('azureInsightsApiKey');
                    
                    if (storedAppId && storedApiKey) {
                        applicationIdInput.value = storedAppId;
                        apiKeyInput.value = storedApiKey;
                    }
                } catch (e) {
                    console.error('Failed to retrieve stored credentials:', e);
                }
            }
        });
    </script>
</body>
</html>
